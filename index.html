<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Utmatic Modular</title>
  <!-- Work Sans Google Fonts import -->
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- PDF.js CSS (for built-in viewer toolbar, optional but recommended) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf_viewer.min.css">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --success: #22c55e;
      --gray-bg: #fff;
      --gray-100: #f5f7fa;
      --gray-200: #e5e7eb;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --danger: #f43f5e;
      --radius: 12px;
      --transition: 0.18s cubic-bezier(.4,0,.2,1);
      --input-bg: #fff;
      --input-border: #cbd5e1;
      --input-focus: #2563eb;
      --input-shadow: 0 0 0 2px rgba(37,99,235,.08);
      --label: #334155;
      --placeholder: #94a3b8;
      --col1: #2563eb;
      --col2: #1e40af;
      --col3: #22c55e;
      --spinner-overlay-bg: rgba(20,24,32,0.92);
    }
    html, body {
      height: 100%;
      background: var(--gray-bg);
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
      color: #23272f;
      min-height: 100vh;
      letter-spacing: 0.01em;
      font-size: 16px;
      background: var(--gray-bg);
    }
    .page-wrapper {
      max-width: 1200px;
      margin: 0 auto;
      padding: 3.6rem 1rem 2.5rem 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: var(--gray-bg);
    }
    .main-group {
      width: 100%;
      max-width: 1080px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .header-container {
      width: 100%;
      max-width: 600px;
      margin-bottom: 2.2rem;
      padding-left: 0;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0;
    }
    .logo {
      height: 42px;
      width: auto;
      display: block;
      margin-bottom: 0.3rem;
    }
    .header-text {
      width: 100%;
      margin-left: 0;
      text-align: left;
      margin-top: 0;
    }
    .header-container p {
      color: var(--gray-400);
      font-size: 1.1rem;
      margin: 1.4rem 0 0 0;
      letter-spacing: 0.01em;
      font-weight: 500;
      text-align: left;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
    }
    .container {
      display: flex;
      align-items: flex-start;
      width: 100%;
      gap: 2.5rem;
    }
    .form-container {
      background: #fff;
      padding: 2.6rem 2rem 2rem 2rem;
      border: 1.5px solid var(--gray-200);
      border-radius: var(--radius);
      width: 100%;
      max-width: 650px;
      min-width: 370px;
      min-height: 610px;
      display: flex;
      flex-direction: column;
      z-index: 1;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
    }
    .file-list {
      background: #fff;
      padding: 1.3rem 1.2rem 1.5rem 1.2rem;
      border: 1.5px solid var(--gray-200);
      border-radius: var(--radius);
      width: 350px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
    }
    .file-list strong {
      font-size: 1.1rem;
      color: var(--label);
      margin-bottom: 0.4rem;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
    }
    .file-list ul {
      list-style: none;
      padding: 0;
      margin: 0.5rem 0;
    }
    .file-list li {
      margin-bottom: 0.5rem;
      color: var(--gray-400);
      font-size: 1.01rem;
      background: var(--gray-100);
      padding: 0.25rem 0.7rem;
      border-radius: 6px;
      transition: background var(--transition);
      display: flex;
      align-items: center;
      gap: 0.4em;
      position: relative;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
      /* Disable text wrapping for file names in File List */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .file-list li .file-list-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 140px;
      display: inline-block;
      vertical-align: middle;
    }
    .file-list li .job-icons {
      display: flex;
      align-items: center;
      gap: 0.18em;
      margin-right: 0.2em;
    }
    .file-list li .checkmark {
      width: 24px;
      height: 24px;
      margin-right: 0.5em;
      margin-left: -0.2em;
      display: inline-block;
      vertical-align: middle;
      pointer-events: none;
    }
    .file-list li.saved .checkmark {
      display: inline-block;
    }
    .file-list li:not(.saved) .checkmark {
      display: none;
    }
    .file-list li.saved {
      color: #1a1a1a;
      background: var(--gray-bg);
      font-weight: 600;
    }
    /* Animated checkmark styles */
    .checkmark__circle {
      stroke-dasharray: 166;
      stroke-dashoffset: 166;
      stroke-width: 2;
      stroke-miterlimit: 10;
      stroke: green;
      fill: none;
      animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }
    .checkmark {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: inline-block;
      stroke-width: 2;
      stroke: green;
      stroke-miterlimit: 10;
      box-shadow: none;
      animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
      background: transparent;
      margin: 0 0.15em 0 0;
      vertical-align: middle;
    }
    .checkmark__check {
      transform-origin: 50% 50%;
      stroke-dasharray: 48;
      stroke-dashoffset: 48;
      animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
    }
    @keyframes stroke {
      100% {
        stroke-dashoffset: 0;
      }
    }
    @keyframes scale {
      0%, 100% {
        transform: none;
      }
      50% {
        transform: scale3d(1.1, 1.1, 1);
      }
    }
    @keyframes fill {
      100% {
        box-shadow: inset 0px 0px 0px 30px #fff;
      }
    }
    .tab-bar {
      display: flex;
      align-items: flex-end;
      gap: 0.2rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--gray-200);
      background: none;
      padding: 0;
      min-height: 36px;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
    }
    .tab {
      background: transparent;
      color: #23272f;
      border: none;
      border-radius: 7px 7px 0 0;
      padding: 0.2em 1.1em;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      margin-bottom: 0;
      transition: background 0.15s, color 0.15s;
      position: relative;
      min-width: 80px;
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      display: flex;
      align-items: center;
      height: 36px;
      z-index: 1;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
    }
    .tab.active {
      background: #fff;
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
      font-weight: 600;
      z-index: 2;
    }
    .tab .tab-label {
      flex: 1 1 auto;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
    }
    .tab .delete-tab {
      background: none;
      border: none;
      color: var(--danger);
      font-size: 1.15em;
      margin-left: 7px;
      cursor: pointer;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s, color 0.15s;
      opacity: 0.7;
      position: relative;
    }
    .tab .delete-tab:hover {
      background: var(--danger);
      color: #fff;
      opacity: 1;
    }
    .tab .delete-tab[disabled] {
      display: none;
    }
    #add-tab.tab {
      background: #1a1a1a !important;
      color: #fff !important;
      min-width: 36px !important;
      max-width: 36px !important;
      width: 36px !important;
      height: 36px !important;
      padding: 0 !important;
      font-size: 1.5rem !important;
      font-weight: 900 !important;
      border-radius: 7px 7px 0 0 !important;
      display: flex !important;
      align-items: center;
      justify-content: center;
      margin-right: 0.3rem;
      box-shadow: none;
      cursor: pointer;
      transition: background 0.18s, color 0.18s, opacity 0.18s;
      z-index: 10;
      flex: 0 0 36px;
      order: -1;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
    }
    #add-tab:disabled {
      background: var(--gray-300) !important;
      color: #fff !important;
      cursor: not-allowed;
      opacity: 0.5;
    }
    .field-row-wrapper {
      width: 100%;
      margin-top: 0.2em;
      position: relative;
      padding-top: 0;
    }
    .add-new-row-btn {
      color: var(--primary);
      cursor: pointer;
      background: none;
      border: none;
      font-size: 0.98rem;
      font-weight: 500;
      padding: 0;
      text-align: left;
      transition: color var(--transition);
      display: block;
      margin-bottom: 0.18em;
      margin-left: 0;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
    }
    .add-new-row-btn:disabled {
      color: var(--gray-300);
      cursor: not-allowed;
    }
    @media (max-width: 600px) {
      .tab-bar {
        gap: 0.1rem;
      }
      .tab {
        min-width: 60px;
        font-size: 0.92rem;
        padding: 0.15em 0.7em;
        height: 30px;
      }
      #add-tab.tab {
        min-width: 30px !important;
        max-width: 30px !important;
        width: 30px !important;
        height: 30px !important;
        font-size: 1.12rem !important;
      }
      .field-row-wrapper {
        padding-top: 0;
      }
      .add-new-row-btn {
        font-size: 0.96rem;
        margin-bottom: 0.13em;
      }
      .header-container {
        max-width: 100%;
      }
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .field-group {
      margin-bottom: 1.13rem;
      width: 100%;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
    }
    .field-group label {
      display: block;
      font-weight: 600;
      color: var(--label);
      margin-bottom: 0.28rem;
      font-size: 1.01rem;
      letter-spacing: 0.01em;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
    }
    .field-row {
      display: flex;
      align-items: center;
      gap: 0.7em;
      margin-bottom: 1.2rem;
      width: 100%;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
    }
    .field-row .field-group {
      margin-bottom: 0 !important;
      flex: 1 1 0;
      min-width: 0;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
    }
    .field-row .field-group input {
      flex: 1 1 auto;
      min-width: 0;
      width: 100%;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
    }
    .field-row .delete-col {
      width: 2.3em;
      min-width: 2.3em;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .utm-label {
      font-weight: 600;
      color: var(--label);
      margin-bottom: 0.3rem;
      display: block;
      font-size: 1.01rem;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
    }
    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      margin-bottom: 1.12rem;
      font-size: 1rem;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
    }
    .form-actions {
      margin-top: 1rem;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
    }
    .save-btn,
    .process-btn {
      width: 100%;
      font-size: 1.09rem;
      padding: 0.68rem 1rem;
      border: none;
      border-radius: 7px;
      cursor: pointer;
      transition: background 0.19s, color 0.19s, opacity 0.19s, box-shadow 0.19s;
      margin-bottom: 0.5rem;
      font-weight: 600;
      box-shadow: none;
      letter-spacing: 0.01em;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
    }
    .save-btn {
      background: linear-gradient(90deg, var(--primary) 70%, var(--primary-dark) 100%);
      color: #fff;
      border: none;
    }
    .save-btn:hover:enabled {
      background: linear-gradient(90deg, #1e40af 40%, #2563eb 100%);
    }
    .process-btn {
      background: linear-gradient(90deg, var(--success) 80%, #16a34a 100%);
      color: #fff;
      border: none;
    }
    .process-btn:hover:enabled {
      background: linear-gradient(90deg, #16a34a 30%, var(--success) 100%);
    }
    .save-btn:disabled,
    .process-btn:disabled {
      background: var(--gray-200) !important;
      color: #818a97 !important;
      cursor: not-allowed;
      opacity: 0.75;
      box-shadow: none;
    }
    button:hover { cursor: pointer; }
    .hidden { display: none !important; }
    input[type="text"],
    input[type="file"],
    select {
      width: 100%;
      padding: 0.62rem 0.68rem;
      font-size: 1.03rem;
      border: 1.5px solid var(--input-border);
      border-radius: 7px;
      background: var(--input-bg);
      color: #23272f;
      transition: border-color var(--transition), box-shadow var(--transition);
      outline: none;
      box-sizing: border-box;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
      letter-spacing: 0.01em;
    }
    input[type="text"]:focus,
    select:focus {
      border-color: var(--input-focus);
      box-shadow: var(--input-shadow);
      background: #f8fafc;
    }
    input[readonly] {
      background: #f4f4f4;
      color: #a3a3a3;
      cursor: not-allowed;
    }
    input::placeholder {
      color: var(--placeholder);
      opacity: 1;
      font-size: 0.99em;
      font-weight: 500;
      letter-spacing: 0.01em;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
    }
    .custom-file-input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      width: 100%;
      max-width: 100%;
    }
    .custom-file-input-label {
      display: inline-flex;
      align-items: center;
      padding: 0.62rem 1.2rem 0.62rem 1.2rem;
      background: #1a1a1a;
      color: #fff !important;
      font-weight: 600;
      border-radius: 7px;
      cursor: pointer;
      font-size: 1.04rem;
      box-shadow: none;
      border: none;
      transition: background 0.15s;
      outline: none;
      margin-right: 1rem;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
      position: relative;
      white-space: nowrap;
      text-decoration: none;
    }
    .custom-file-input-label:hover, .custom-file-input-label:focus {
      background: #333;
      color: #fff !important;
      cursor: pointer;
    }
    .custom-file-input-label:active {
      color: #fff !important;
    }
    .custom-file-input {
      opacity: 0;
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
      z-index: 2;
      font-size: 18px;
    }
    .custom-file-filename {
      color: var(--label);
      font-size: 1.01rem;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 70%;
      display: inline-block;
      vertical-align: middle;
    }
    #spinner-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100vw;
      height: 100vh;
      background: var(--spinner-overlay-bg);
      z-index: 99999;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    #spinner-overlay.active {
      display: flex;
    }
    .spinner-headline {
      font-size: 2.2rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 42px;
      letter-spacing: 0.07em;
      text-shadow: 0 4px 32px #0009;
      font-family: 'Work Sans', 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
      user-select: none;
      text-align: center;
      line-height: 1.08;
      text-transform: uppercase;
      letter-spacing: 0.19em;
      transition: color 0.18s;
    }
    .processing-dots {
      display: inline-block;
      font-family: inherit;
      font-weight: 700;
      font-size: 1em;
      letter-spacing: 0.12em;
      margin-left: 0.25em;
      min-width: 2.5ch;
      color: #fff;
      transition: color 0.18s;
      vertical-align: middle;
    }
    .dots-spinner {
      width: 3.6rem;
      height: 3.4rem;
      position: relative;
      animation: spin 2s linear infinite;
      margin: 0 auto;
    }
    .dots-spinner > span {
      display: block;
      --size: 1.2rem;
      height: var(--size);
      width: var(--size);
      background-color: var(--col1);
      border-radius: 50%;
      position: absolute;
      animation: pulse 3s ease-out infinite var(--delay),
                 colorChange 4s linear infinite;
    }
    .dot-1 {
      top: 0;
      left: calc(50% - (var(--size) / 2));
      --delay: 2s;
    }
    .dot-2 {
      bottom: 0;
      left: 0;
      --delay: 1s;
    }
    .dot-3 {
      bottom: 0;
      right: 0;
      --delay: 0s;
    }
    @keyframes pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.2);
      }
      100% {
        transform: scale(1);
      }
    }
    @keyframes colorChange {
      0% {
        background-color: var(--col1);
      }
      33.33% {
        background-color: var(--col2);
      }
      66.66% {
        background-color: var(--col3);
      }
      100% {
        background-color: var(--col1);
      }
    }
    @keyframes spin {
      100% {
        transform: rotate(360deg);
      }
    }
    #pdf-previewer-modal {
      display: none;
      position: fixed;
      z-index: 100000;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(20,24,32,0.96);
      align-items: center;
      justify-content: center;
      flex-direction: column;
      transition: opacity 0.19s;
    }
    #pdf-previewer-modal.active {
      display: flex;
    }
    .pdf-previewer-content {
      background: #181e2b;
      border-radius: 16px;
      box-shadow: 0 8px 32px #0007;
      max-width: 93vw;
      max-height: 90vh;
      padding: 0 0 26px 0;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      overflow: hidden;
      position: relative;
    }
    .pdf-previewer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 26px 10px 26px;
      background: #232c46;
      border-radius: 16px 16px 0 0;
    }
    .pdf-previewer-title {
      color: #fff;
      font-size: 1.18rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      flex: 1 1 auto;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin-right: 1.5rem;
    }
    .pdf-previewer-close {
      font-size: 1.9rem;
      color: #cdd4e7;
      background: none;
      border: none;
      cursor: pointer;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s, color 0.15s;
      margin-left: 1.5rem;
    }
    .pdf-previewer-close:hover {
      background: #334155;
      color: #fff;
    }
    .pdf-previewer-switcher {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: 0.4rem;
    }
    .pdf-previewer-switch-btn {
      background: #232c46;
      color: #fff;
      border: none;
      border-radius: 7px;
      font-size: 1.13rem;
      font-weight: 600;
      padding: 4px 14px;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
      margin: 0 0.1rem;
      opacity: 0.86;
    }
    .pdf-previewer-switch-btn.active,
    .pdf-previewer-switch-btn:focus {
      background: #2563eb;
      color: #fff;
      opacity: 1;
    }
    .pdf-previewer-switch-btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }
    .pdf-previewer-download-btn {
      background: #22c55e;
      color: #fff;
      border: none;
      border-radius: 7px;
      font-size: 1.1rem;
      font-weight: 700;
      padding: 5px 20px;
      cursor: pointer;
      margin-left: 1.6rem;
      margin-right: 0;
      transition: background 0.16s, color 0.16s;
      display: flex;
      align-items: center;
    }
    .pdf-previewer-download-btn:hover {
      background: #15803d;
    }
    .pdf-preview-pdfjs-root {
      background: #232c46;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: auto;
      max-width: 100vw;
      max-height: 72vh;
      padding: 0 0.5vw;
    }
    .pdf-preview-pdfjs-root > #pdfjs-viewer {
      width: auto;
      min-width: 340px;
      min-height: 440px;
      background: #232c46;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 0px 5px #0007;
      margin: 0 auto;
      max-width: 85vw;
      max-height: 70vh;
      overflow: auto;
    }
    #pdfjs-viewer .toolbar,
    #pdfjs-viewer .sidebarContainer {
      display: none !important;
    }
    /* Remove all carets except in editable fields */
    *:not(input):not(textarea):not(select):not([contenteditable="true"]) {
      caret-color: transparent !important;
    }
    input, textarea, select, [contenteditable="true"] {
      caret-color: auto !important;
    }
    /* Keep text selectable everywhere */
    body, .tab, .tab-label, .file-list, .file-list li, .pdf-previewer-title, .pdf-previewer-header, .pdf-previewer-content {
      user-select: text;
    }
    button:not([contenteditable="true"]) {
      user-select: none;
    }
  </style>
</head>
<body>
  <!-- Spinner Overlay -->
  <div id="spinner-overlay">
    <div class="spinner-headline">
      Processing
      <span class="processing-dots">...</span>
    </div>
    <div class="dots-spinner">
      <span class="dot-1"></span>
      <span class="dot-2"></span>
      <span class="dot-3"></span>
    </div>
  </div>
  <!-- PDF Previewer Modal -->
  <div id="pdf-previewer-modal">
    <div class="pdf-previewer-content">
      <div class="pdf-previewer-header">
        <span class="pdf-previewer-title" id="pdf-previewer-title"></span>
        <div class="pdf-previewer-switcher" id="pdf-previewer-switcher"></div>
        <button class="pdf-previewer-download-btn" id="pdf-previewer-download">Download</button>
        <button class="pdf-previewer-close" id="pdf-previewer-close" title="Close Preview" aria-label="Close Preview">&times;</button>
      </div>
      <div class="pdf-preview-pdfjs-root">
        <div id="pdfjs-viewer"></div>
      </div>
    </div>
  </div>
  <div class="page-wrapper">
    <div class="main-group">
      <div class="header-container">
        <img class="logo" src="https://static1.squarespace.com/static/680bb671dac3025d584cb957/t/6821ece9779432159d432868/1747053801328/logo-utmatic-nobackground.png" alt="Utmatic Logo" />
        <div class="header-text">
          <p>Equip your documents with tracking links — <em>instantly.</em></p>
        </div>
      </div>
      <div class="container">
        <div class="form-container">
          <div class="tab-bar" id="tab-bar">
            <button id="add-tab" class="tab" title="Add New Document" aria-label="Add New Document">+</button>
          </div>
          <div id="tab-contents"></div>
        </div>
        <div class="file-list">
          <strong>File List</strong>
          <ul id="file-list"></ul>
          <button id="process-btn" class="process-btn" disabled>Process PDFs</button>
        </div>
      </div>
    </div>
  </div>
  <datalist id="base-url-datalist"></datalist>
  <!-- PDF.js library (core and viewer) -->
  <script src="https://unpkg.com/pdfjs-dist@4.2.67/build/pdf.min.js"></script>
  <script src="https://unpkg.com/pdfjs-dist@4.2.67/web/pdf_viewer.js"></script>
  <script>
    // SVG ICONS
    const TAG_ICON = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="height:1.15em;vertical-align:-0.13em;"><path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 0 0 3 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 0 0 5.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 0 0 9.568 3Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6Z"/></svg>`;
    const LINK_ICON = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="height:1.15em;vertical-align:-0.13em;"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244"/></svg>`;

    (function animateProcessingDots(){
      var dots = document.querySelector('.processing-dots');
      if (!dots) return;
      let state = 0;
      setInterval(() => {
        state = (state + 1) % 3;
        dots.textContent = '.'.repeat(state + 1);
      }, 480);
    })();

    let baseUrlMemory = JSON.parse(localStorage.getItem('baseUrlMemory') || "[]");
    function updateBaseUrlMemory(newUrl) {
      if (newUrl && !baseUrlMemory.includes(newUrl)) {
        baseUrlMemory.push(newUrl);
        if (baseUrlMemory.length > 15) baseUrlMemory.shift();
        localStorage.setItem('baseUrlMemory', JSON.stringify(baseUrlMemory));
      }
      let dl = document.getElementById('base-url-datalist');
      if (!dl) {
        dl = document.createElement('datalist');
        dl.id = 'base-url-datalist';
        document.body.appendChild(dl);
      }
      dl.innerHTML = baseUrlMemory.map(url => `<option value="${url}">`).join('');
    }
    updateBaseUrlMemory("");
    let docCount = 1;
    const MAX_DOCS = 5;
    const MAX_TARGET_ROWS = 5;
    const tabBar = document.getElementById("tab-bar");
    const tabContents = document.getElementById("tab-contents");
    const fileList = document.getElementById("file-list");
    const processBtn = document.getElementById("process-btn");

    // Track per-tab last saved state for Save/Dirty logic
    let tabLastSavedState = {};

    function showSpinner() { document.getElementById('spinner-overlay').classList.add('active'); }
    function hideSpinner() { document.getElementById('spinner-overlay').classList.remove('active'); }
    function getTabCount() { return tabBar.querySelectorAll(".tab[data-tab]").length; }
    function updateDeleteTabButtons() {
      const tabs = tabBar.querySelectorAll(".tab[data-tab]");
      const count = tabs.length;
      tabs.forEach(tab => {
        const delBtn = tab.querySelector(".delete-tab");
        if (delBtn) {
          delBtn.disabled = (count === 1);
          if (count === 1) {
            delBtn.setAttribute("disabled", "true");
            delBtn.style.opacity = "0.3";
            delBtn.style.cursor = "not-allowed";
          } else {
            delBtn.removeAttribute("disabled");
            delBtn.style.opacity = "";
            delBtn.style.cursor = "";
          }
        }
      });
    }
    function updateAddTabButton() {
      const addTabBtn = document.getElementById("add-tab");
      const numDocs = getTabCount();
      addTabBtn.disabled = numDocs >= MAX_DOCS;
      addTabBtn.style.opacity = numDocs >= MAX_DOCS ? "0.5" : "1";
      addTabBtn.style.cursor = numDocs >= MAX_DOCS ? "not-allowed" : "pointer";
    }
    function updateTabBarCount() {
      const numTabs = getTabCount();
      tabBar.setAttribute('data-tabs', numTabs);
      updateDeleteTabButtons();
    }
    function setActiveTab(tabId) {
      document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
      document.querySelectorAll(".tab-bar .tab").forEach(t => t.classList.remove("active"));
      document.querySelector(`.tab-content#${tabId}`)?.classList.add("active");
      document.querySelector(`.tab-bar .tab[data-tab="${tabId}"]`)?.classList.add("active");
    }

    // Helper to build a unique hash of form data (for Save/Dirty logic)
    function formToHash(form) {
      // Custom serialization: input type, name, value, checked, selectedIndex, file name if any
      let arr = [];
      Array.from(form.elements).forEach(el => {
        if (el.name && !el.disabled && !el.closest('.hidden')) {
          if (el.type === "file") {
            arr.push(el.name + ":" + (el.files[0]?.name || ""));
          } else if (el.type === "checkbox" || el.type === "radio") {
            arr.push(el.name + ":" + (el.checked ? "1" : "0"));
          } else if (el.tagName === "SELECT") {
            arr.push(el.name + ":" + el.selectedIndex);
          } else {
            arr.push(el.name + ":" + el.value);
          }
        }
      });
      return arr.join("|");
    }

    function updateFileListStatus(tabId, name, saved, jobType) {
      let item = fileList.querySelector(`[data-tab="${tabId}"]`);
      if (!item) {
        item = document.createElement("li");
        item.dataset.tab = tabId;
        fileList.appendChild(item);
      }
      let jobIcons = item.querySelector('.job-icons');
      if (!jobIcons) {
        jobIcons = document.createElement('span');
        jobIcons.className = 'job-icons';
        item.insertBefore(jobIcons, item.firstChild);
      }
      // Update job icons
      jobIcons.innerHTML = "";
      if (jobType === "utm_only") {
        jobIcons.innerHTML = TAG_ICON;
      } else if (jobType === "links_and_utm") {
        jobIcons.innerHTML = LINK_ICON;
      }
      let existingCheck = item.querySelector(".checkmark");
      if (existingCheck) existingCheck.remove();
      let nameSpan = item.querySelector('.file-list-name');
      if (!nameSpan) {
        nameSpan = document.createElement('span');
        nameSpan.className = 'file-list-name';
        item.appendChild(nameSpan);
      }
      nameSpan.textContent = name || "Untitled Document";
      // Make sure nameSpan is after jobIcons (for ellipsis to work)
      if (nameSpan.previousSibling !== jobIcons) {
        item.insertBefore(nameSpan, null);
      }
      if (saved) {
        item.className = "saved";
        const checkSvg = document.createElement('span');
        checkSvg.innerHTML = `<svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
          <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
          <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>`;
        item.insertBefore(checkSvg, jobIcons.nextSibling);
      } else {
        item.className = "";
      }
      processBtn.disabled = ![...fileList.children].every(li => li.classList.contains("saved")) || fileList.childElementCount === 0;
    }

    // ---- MULTI-FILE UPLOAD ON CHOOSE FILE ----
    function renderFormFields(form, tabId, docName, fileObj) {
      // PDF Upload
      const pdfField = document.createElement("div");
      pdfField.className = "field-group";
      const pdfLabel = document.createElement("label");
      pdfLabel.htmlFor = "file";
      pdfLabel.textContent = "Upload PDF";
      const fileInputWrapper = document.createElement("div");
      fileInputWrapper.className = "custom-file-input-wrapper";
      const fileInputLabel = document.createElement("label");
      fileInputLabel.className = "custom-file-input-label";
      fileInputLabel.textContent = "Choose File";
      fileInputLabel.setAttribute("tabindex", "0");
      // MULTIPLE attribute here!
      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = ".pdf,application/pdf";
      fileInput.name = "file"; // FIXED: must match backend
      fileInput.id = "file";
      fileInput.required = true;
      fileInput.className = "custom-file-input";
      fileInput.tabIndex = -1;
      fileInput.multiple = true;

      const fileNameSpan = document.createElement("span");
      fileNameSpan.className = "custom-file-filename";
      fileNameSpan.textContent = "No file chosen";
      if (fileObj instanceof File) {
        const dt = new DataTransfer();
        dt.items.add(fileObj);
        fileInput.files = dt.files;
        fileNameSpan.textContent = fileObj.name;
        setTimeout(() => {
          const filenameInput = form.querySelector("input[name='filename']");
          if (filenameInput) {
            let base = fileObj.name.replace(/\.pdf$/i, "");
            filenameInput.value = base;
            const tabLabel = document.querySelector(`.tab[data-tab="${tabId}"] .tab-label`);
            if (tabLabel) tabLabel.textContent = base;
            // Fix: update file list with correct job type (if select is present)
            let jtSelect = form.querySelector('select[name="job_type"]');
            let jt = jtSelect ? jtSelect.value : "";
            updateFileListStatus(tabId, base, false, jt);
          }
        });
      }

      fileInput.addEventListener("change", function() {
        if (fileInput.files && fileInput.files.length > 0) {
          // If user selects multiple files: fill current, add new tabs for others
          const files = Array.from(fileInput.files);
          if (files.length > 1) {
            // Only fill this tab with the first, and create more for others
            fileInput.files = (function() {
              let dt = new DataTransfer();
              dt.items.add(files[0]);
              return dt.files;
            })();
            fileNameSpan.textContent = files[0].name;
            const filenameInput = form.querySelector("input[name='filename']");
            if (filenameInput) {
              let base = files[0].name.replace(/\.pdf$/i, "");
              filenameInput.value = base;
              const tabLabel = document.querySelector(`.tab[data-tab="${tabId}"] .tab-label`);
              if (tabLabel) tabLabel.textContent = base;
              let jtSelect = form.querySelector('select[name="job_type"]');
              let jt = jtSelect ? jtSelect.value : "";
              updateFileListStatus(tabId, base, false, jt);
              // On file change, always clear last saved state (force Save to be enabled)
              tabLastSavedState[tabId] = "";
              form.querySelector('.save-btn').disabled = false;
            }
            // Now create tabs for each subsequent file, if space left
            let slots = MAX_DOCS - getTabCount();
            for (let i = 1; i < files.length && slots > 0; ++i, --slots) {
              createTab(files[i]);
            }
          } else {
            fileNameSpan.textContent = files[0].name;
            const filenameInput = form.querySelector("input[name='filename']");
            if (filenameInput) {
              let base = files[0].name.replace(/\.pdf$/i, "");
              filenameInput.value = base;
              const tabLabel = document.querySelector(`.tab[data-tab="${tabId}"] .tab-label`);
              if (tabLabel) tabLabel.textContent = base;
              let jtSelect = form.querySelector('select[name="job_type"]');
              let jt = jtSelect ? jtSelect.value : "";
              updateFileListStatus(tabId, base, false, jt);
              // Always clear last saved state (force Save to be enabled)
              tabLastSavedState[tabId] = "";
              form.querySelector('.save-btn').disabled = false;
            }
          }
        } else {
          fileNameSpan.textContent = "No file chosen";
        }
      });

      fileInputLabel.appendChild(fileInput);
      fileInputWrapper.appendChild(fileInputLabel);
      fileInputWrapper.appendChild(fileNameSpan);
      pdfField.appendChild(pdfLabel);
      pdfField.appendChild(fileInputWrapper);
      form.appendChild(pdfField);

      // --- Job Type ---
      const jobTypeField = document.createElement("div");
      jobTypeField.className = "field-group";
      const jobTypeLabel = document.createElement("label");
      jobTypeLabel.htmlFor = "job_type";
      jobTypeLabel.textContent = "Job Type";
      const jobTypeSelect = document.createElement("select");
      jobTypeSelect.name = "job_type";
      jobTypeSelect.id = "job_type";
      jobTypeSelect.required = true;
      [
        { value: "", label: "Select one", icon: "" },
        { value: "utm_only", label: "Add UTM Only", icon: TAG_ICON },
        { value: "links_and_utm", label: "Add Links and UTM", icon: LINK_ICON }
      ].forEach(opt => {
        const option = document.createElement("option");
        option.value = opt.value;
        option.textContent = opt.label;
        jobTypeSelect.appendChild(option);
      });
      // Add icons to job type select (visually, not in option text)
      const decorateJobTypeSelect = () => {
        // Remove any existing decorations
        jobTypeSelect.querySelectorAll(".icon-option").forEach(n => n.remove());
        Array.from(jobTypeSelect.options).forEach((opt, idx) => {
          // Only for non-defaults
          if (idx === 0) return;
          opt.textContent = "";
          let span = document.createElement("span");
          span.style.display = "inline-flex";
          span.style.alignItems = "center";
          span.innerHTML = (idx === 1 ? TAG_ICON : idx === 2 ? LINK_ICON : "") + " " +
            (idx === 1 ? "Add UTM Only" : idx === 2 ? "Add Links and UTM" : "");
          opt.appendChild(span);
        });
      };
      // For native selects, cannot inject icons, so use a small CSS hack for Chrome/Edge, and fallback otherwise.
      // We'll update the file list with icons instead.
      jobTypeField.appendChild(jobTypeLabel);
      jobTypeField.appendChild(jobTypeSelect);
      form.appendChild(jobTypeField);

      // --- Target Format & Base URL dynamic rows ---
      const targetBaseRowsWrapper = document.createElement("div");
      targetBaseRowsWrapper.className = "field-row-wrapper hidden";
      form.appendChild(targetBaseRowsWrapper);
      const addNewRowBtn = document.createElement("button");
      addNewRowBtn.type = "button";
      addNewRowBtn.className = "add-new-row-btn";
      addNewRowBtn.textContent = "+ Add new";
      addNewRowBtn.style.marginLeft = "0";
      addNewRowBtn.style.marginBottom = "0.18em";
      addNewRowBtn.style.marginTop = "0";
      addNewRowBtn.style.display = "block";
      targetBaseRowsWrapper.appendChild(addNewRowBtn);
      addTargetBaseRow(targetBaseRowsWrapper, form);
      function addTargetBaseRow(wrapper, form) {
        const fieldRow = document.createElement("div");
        fieldRow.className = "field-row";
        // Target Format
        const tfGroup = document.createElement("div");
        tfGroup.className = "field-group";
        tfGroup.style.flex = "1";
        tfGroup.style.minWidth = 0;
        const tfInput = document.createElement("input");
        tfInput.type = "text";
        tfInput.name = "target_format";
        tfInput.placeholder = "Target Format";
        tfInput.required = true;
        tfInput.style.width = "100%";
        tfInput.style.boxSizing = "border-box";
        tfGroup.appendChild(tfInput);
        // Base URL
        const buGroup = document.createElement("div");
        buGroup.className = "field-group";
        buGroup.style.flex = "1";
        buGroup.style.minWidth = 0;
        const buInput = document.createElement("input");
        buInput.type = "text";
        buInput.name = "base_url";
        buInput.placeholder = "Base URL";
        buInput.required = true;
        buInput.setAttribute('list', 'base-url-datalist');
        buInput.style.width = "100%";
        buInput.style.boxSizing = "border-box";
        buGroup.appendChild(buInput);
        buInput.addEventListener('change', () => {
          updateBaseUrlMemory(buInput.value.trim());
        });
        // Remove Button (except for first row)
        const delCol = document.createElement("div");
        delCol.className = "delete-col";
        if (wrapper.querySelectorAll(".field-row").length > 0) {
          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.textContent = "✕";
          removeBtn.style.background = "none";
          removeBtn.style.border = "none";
          removeBtn.style.color = "#f43f5e";
          removeBtn.style.fontSize = "1.25rem";
          removeBtn.style.cursor = "pointer";
          removeBtn.title = "Remove row";
          removeBtn.addEventListener("click", function() {
            fieldRow.remove();
            updateAddNewRowBtn();
            validateForm(form);
          });
          delCol.appendChild(removeBtn);
        } else {
          delCol.innerHTML = "&nbsp;";
        }
        fieldRow.appendChild(tfGroup);
        fieldRow.appendChild(buGroup);
        fieldRow.appendChild(delCol);
        wrapper.appendChild(fieldRow);
        updateAddNewRowBtn();
        updateBaseUrlMemory("");
      }
      function updateAddNewRowBtn() {
        const numRows = targetBaseRowsWrapper.querySelectorAll(".field-row").length;
        addNewRowBtn.disabled = numRows >= MAX_TARGET_ROWS;
      }
      addNewRowBtn.addEventListener("click", function() {
        addTargetBaseRow(targetBaseRowsWrapper, form);
        updateAddNewRowBtn();
      });

      // --- UTM Parameters group ---
      const utmLabel = document.createElement("span");
      utmLabel.className = "utm-label";
      utmLabel.textContent = "UTM Parameters";
      form.appendChild(utmLabel);
      const utmRow = document.createElement("div");
      utmRow.className = "utm-row";
      // FIXED: use correct field names for backend
      [
        { id: "source", placeholder: "Source", required: true },
        { id: "medium", placeholder: "Medium", required: true },
        { id: "campaign", placeholder: "Campaign", required: true }
      ].forEach(field => {
        const group = document.createElement("div");
        group.className = "field-group";
        const input = document.createElement("input");
        input.type = "text";
        input.name = field.id; // FIXED
        input.placeholder = field.placeholder;
        input.required = true;
        group.appendChild(input);
        utmRow.appendChild(group);
      });
      form.appendChild(utmRow);
      const utmContentGroup = document.createElement("div");
      utmContentGroup.className = "field-group";
      const utmContentInput = document.createElement("input");
      utmContentInput.type = "text";
      utmContentInput.name = "utm_content";
      utmContentInput.placeholder = "Content (automatic)";
      utmContentInput.readOnly = true;
      utmContentInput.style.backgroundColor = "#f9f9f9";
      utmContentInput.style.cursor = "not-allowed";
      utmContentGroup.appendChild(utmContentInput);
      form.appendChild(utmContentGroup);
      const filenameGroup = document.createElement("div");
      filenameGroup.className = "field-group";
      const filenameLabel = document.createElement("label");
      filenameLabel.htmlFor = "filename";
      filenameLabel.textContent = "Document Name";
      const filenameInput = document.createElement("input");
      filenameInput.type = "text";
      filenameInput.name = "filename";
      filenameInput.id = "filename";
      filenameInput.placeholder = "MyFileName";
      filenameInput.required = true;
      filenameInput.value = docName || '';
      filenameGroup.appendChild(filenameLabel);
      filenameGroup.appendChild(filenameInput);
      form.appendChild(filenameGroup);
      const underlineWrapper = document.createElement("div");
      underlineWrapper.className = "checkbox-wrapper hidden";
      underlineWrapper.style.marginBottom = "0.75rem";
      underlineWrapper.style.marginTop = "-0.5rem";
      const underlineInput = document.createElement("input");
      underlineInput.type = "checkbox";
      underlineInput.name = "underline";
      underlineInput.id = "underline";
      const underlineLabel = document.createElement("label");
      underlineLabel.htmlFor = "underline";
      underlineLabel.textContent = "Add underline to links?";
      underlineWrapper.appendChild(underlineInput);
      underlineWrapper.appendChild(underlineLabel);
      form.appendChild(underlineWrapper);
      const actionsDiv = document.createElement("div");
      actionsDiv.className = "form-actions";
      const saveBtn = document.createElement("button");
      saveBtn.type = "submit";
      saveBtn.textContent = "Save";
      saveBtn.className = "save-btn";
      saveBtn.disabled = true;
      actionsDiv.appendChild(saveBtn);
      form.appendChild(actionsDiv);

      // --- Save/Dirty logic ---
      // Track last saved hash for this tab
      tabLastSavedState[tabId] = "";

      function checkDirtyAndUpdateSaveBtn() {
        let current = formToHash(form);
        let dirty = current !== tabLastSavedState[tabId] && saveBtn.dataset.justSaved !== "1";
        saveBtn.disabled = !formIsValid(form) || !dirty;
      }
      function formIsValid(form) {
        let valid = true;
        form.querySelectorAll("input, select").forEach(input => {
          if (
            !input.closest(".hidden") &&
            input.required &&
            ((input.type === "file" && input.files.length === 0) ||
             (input.type !== "file" && !input.value.trim()))
          ) {
            valid = false;
          }
        });
        return valid;
      }
      // Validate and update save button whenever form changes
      form.addEventListener("input", function() {
        checkDirtyAndUpdateSaveBtn();
      });
      form.addEventListener("change", function() {
        checkDirtyAndUpdateSaveBtn();
      });

      // Save handler
      form.addEventListener("submit", function(e) {
        e.preventDefault();
        const filenameInput = form.querySelector("input[name='filename']");
        const name = filenameInput?.value || docName;
        const jt = jobTypeSelect.value;
        updateFileListStatus(tabId, name, true, jt);
        // Save hash
        tabLastSavedState[tabId] = formToHash(form);
        saveBtn.disabled = true;
        saveBtn.dataset.justSaved = "1";
        setTimeout(()=>{ saveBtn.dataset.justSaved = ""; }, 500);
      });

      // Job type select: update file list with correct icon
      jobTypeSelect.addEventListener("change", function() {
        const show = jobTypeSelect.value === "links_and_utm";
        targetBaseRowsWrapper.classList.toggle("hidden", !show);
        underlineWrapper.classList.toggle("hidden", !show);
        targetBaseRowsWrapper.querySelectorAll("input[name='target_format'], input[name='base_url']").forEach(input => {
          input.required = show;
        });
        underlineInput.required = false;
        // Update icon in file list
        const filenameInput = form.querySelector("input[name='filename']");
        updateFileListStatus(tabId, filenameInput.value, false, jobTypeSelect.value);
        checkDirtyAndUpdateSaveBtn();
      });

      // When filename is changed, update tab label and file list (don't mark as saved)
      filenameInput.addEventListener("input", () => {
        const tabLabel = document.querySelector(`.tab[data-tab="${tabId}"] .tab-label`);
        tabLabel.textContent = filenameInput.value || `Document ${tabId.replace(/doc-/, '')}`;
        updateFileListStatus(tabId, filenameInput.value, false, jobTypeSelect.value);
        checkDirtyAndUpdateSaveBtn();
      });

      // File input change: update filename and clear saved state
      fileInput.addEventListener("change", function() {
        if (fileInput.files && fileInput.files.length > 0) {
          let base = fileInput.files[0].name.replace(/\.pdf$/i, "");
          filenameInput.value = base;
          const tabLabel = document.querySelector(`.tab[data-tab="${tabId}"] .tab-label`);
          if (tabLabel) tabLabel.textContent = base;
          updateFileListStatus(tabId, base, false, jobTypeSelect.value);
          tabLastSavedState[tabId] = "";
          saveBtn.disabled = false;
        }
      });

      // Initial file list status update
      updateFileListStatus(tabId, filenameInput.value, false, jobTypeSelect.value);

      // Validate at startup
      checkDirtyAndUpdateSaveBtn();

      // Show/hide job type icons in select
      decorateJobTypeSelect();
    }

    function createTab(fileObj) {
      const tabId = `doc-${docCount}`;
      const tabBtn = document.createElement("button");
      tabBtn.className = "tab";
      tabBtn.setAttribute("type", "button");
      tabBtn.setAttribute("title", `Switch to ${tabId}`);
      tabBtn.dataset.tab = tabId;
      const tabLabel = document.createElement("span");
      tabLabel.className = "tab-label";
      tabLabel.textContent = `Document ${docCount}`;
      tabBtn.appendChild(tabLabel);
      const delBtn = document.createElement("button");
      delBtn.setAttribute("type", "button");
      delBtn.className = "delete-tab";
      delBtn.setAttribute("title", "Delete tab");
      delBtn.dataset.tab = tabId;
      delBtn.innerHTML = "&times;";
      tabBtn.appendChild(delBtn);
      tabBtn.addEventListener("click", function(e) {
        if (e.target.classList.contains("delete-tab")) return;
        setActiveTab(tabId);
      });
      tabBar.insertBefore(tabBtn, document.getElementById("add-tab"));
      const tabContent = document.createElement("div");
      tabContent.className = "tab-content";
      tabContent.id = tabId;
      const form = document.createElement("form");
      form.setAttribute("autocomplete", "off");
      renderFormFields(form, tabId, `Document ${docCount}`, fileObj);
      tabContent.appendChild(form);
      tabContents.appendChild(tabContent);
      setActiveTab(tabId);
      docCount++;
      updateAddTabButton();
      updateTabBarCount();
      updateDeleteTabButtons();
    }
    // Initial tab
    createTab();

    // Tab deletion logic
    document.addEventListener("click", function (e) {
      if (e.target.classList && e.target.classList.contains("delete-tab")) {
        if (e.target.hasAttribute('disabled')) return;
        const tabId = e.target.dataset.tab;
        const tab = document.querySelector(`[data-tab="${tabId}"]`);
        const content = document.getElementById(tabId);
        const fileItem = document.querySelector(`.file-list [data-tab="${tabId}"]`);
        if (tab) tab.remove();
        if (content) content.remove();
        if (fileItem) fileItem.remove();
        const remainingTabs = Array.from(tabBar.querySelectorAll(".tab[data-tab]"));
        let newActive = null;
        if (remainingTabs.length) {
          newActive = remainingTabs[remainingTabs.length-1];
        }
        if (newActive) setActiveTab(newActive.dataset.tab);
        updateAddTabButton();
        updateTabBarCount();
        updateDeleteTabButtons();
      }
    });
    updateTabBarCount();

    // PDF Previewer Logic
    const previewerModal = document.getElementById('pdf-previewer-modal');
    const previewerTitle = document.getElementById('pdf-previewer-title');
    const previewerSwitcher = document.getElementById('pdf-previewer-switcher');
    const previewerDownload = document.getElementById('pdf-previewer-download');
    const previewerClose = document.getElementById('pdf-previewer-close');
    const pdfjsViewer = document.getElementById('pdfjs-viewer');

    let previewDocs = []; // Each: { name, blob, url }
    let currentPreviewIdx = 0;

    function openPdfPreviewer(docs, idx) {
      previewDocs = docs;
      currentPreviewIdx = idx || 0;
      if (!previewDocs.length) return;
      updatePreviewerHeader();
      renderPdfInViewer(previewDocs[currentPreviewIdx].url);
      previewerModal.classList.add('active');
    }

    function updatePreviewerHeader() {
      // Title
      previewerTitle.textContent = previewDocs[currentPreviewIdx]?.name || 'Preview';
      // Switcher buttons
      previewerSwitcher.innerHTML = '';
      previewDocs.forEach((doc, idx) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'pdf-previewer-switch-btn' + (idx === currentPreviewIdx ? ' active' : '');
        btn.textContent = doc.name || `Document ${idx+1}`;
        btn.disabled = idx === currentPreviewIdx;
        btn.addEventListener('click', () => {
          currentPreviewIdx = idx;
          updatePreviewerHeader();
          renderPdfInViewer(doc.url);
        });
        previewerSwitcher.appendChild(btn);
      });
    }

    previewerDownload.addEventListener('click', async function() {
  const doc = previewDocs[currentPreviewIdx];
  if (!doc) return;
  // Download the clean PDF from /process using the original formData
  if (doc.formData) {
    // Optionally, show a spinner
    document.getElementById('spinner-overlay').classList.add('active');
    const API_BASE = "https://utmatic-backend.onrender.com";
    try {
      const res = await fetch(`${API_BASE}/process`, {
        method: "POST",
        body: doc.formData
      });
      document.getElementById('spinner-overlay').classList.remove('active');
      if (!res.ok) {
        const errorText = await res.text();
        alert("Download failed: " + errorText);
        return;
      }
      const blob = await res.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (doc.name?.replace(/[^\w.-]+/g, '_') || 'document') + '.pdf';
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(a.href);
      document.body.removeChild(a);
    } catch (err) {
      document.getElementById('spinner-overlay').classList.remove('active');
      alert("Download failed: " + err);
    }
  } else {
    // fallback: download the preview file
    const a = document.createElement('a');
    a.href = doc.url;
    a.download = (doc.name?.replace(/[^\w.-]+/g, '_') || 'document') + '_preview.pdf';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
});

    previewerClose.addEventListener('click', function() {
      previewerModal.classList.remove('active');
      pdfjsViewer.innerHTML = '';
      // Cleanup object URLs
      previewDocs.forEach(doc => { if (doc._tempUrl) URL.revokeObjectURL(doc._tempUrl); });
      previewDocs = [];
    });

    // PDF.js Render Helper
async function renderPdfInViewer(pdfUrl) {
  pdfjsViewer.innerHTML = '';
  // Fix: check if viewer library is loaded
  if (!window.pdfjsViewer) {
    alert("PDF.js Viewer library is not loaded. Cannot preview PDF.");
    return;
  }
  const CMAP_URL = "https://unpkg.com/pdfjs-dist@4.2.67/cmaps/";
  const CMAP_PACKED = true;
  const eventBus = new window.pdfjsViewer.EventBus();
  const pdfLinkService = new window.pdfjsViewer.PDFLinkService({ eventBus });
  const pdfFindController = new window.pdfjsViewer.PDFFindController({ eventBus, linkService: pdfLinkService });
  const pdfViewer = new window.pdfjsViewer.PDFViewer({
    container: pdfjsViewer,
    eventBus,
    linkService: pdfLinkService,
    findController: pdfFindController,
  });
      pdfjsViewer.classList.add('pdfViewer');
      eventBus.on("pagesinit", function() {
        pdfViewer.currentScaleValue = "page-width";
      });
      const loadingTask = pdfjsLib.getDocument({
        url: pdfUrl,
        cMapUrl: CMAP_URL,
        cMapPacked: CMAP_PACKED,
      });
      const pdfDoc = await loadingTask.promise;
      pdfViewer.setDocument(pdfDoc);
      pdfLinkService.setDocument(pdfDoc, null);
      pdfLinkService.setViewer(pdfViewer);
    }

    // Multi-document processing and preview
    processBtn.addEventListener("click", async function() {
      if (processBtn.disabled) return;
      showSpinner();

      // Collect all saved docs
      const docTabs = Array.from(tabBar.querySelectorAll(".tab[data-tab]"));
      const tabData = [];
      for (const tab of docTabs) {
        const tabId = tab.dataset.tab;
        const tabContent = document.getElementById(tabId);
        if (!tabContent) continue;
        const form = tabContent.querySelector("form");
        if (!form) continue;
        // Only include if in file list as "saved"
        if (!fileList.querySelector(`li[data-tab="${tabId}"].saved`)) continue;
        tabData.push({ form, tabId });
      }
      if (!tabData.length) {
        hideSpinner();
        return;
      }

      // Prepare all preview requests
      const previewDocsToShow = [];
      let encounteredError = null;
      const API_BASE = "https://utmatic-backend.onrender.com";
      for (let i = 0; i < tabData.length; ++i) {
        const { form, tabId } = tabData[i];
        const formData = new FormData(form);
        // Fix: ensure correct boolean value for "underline"
        if (formData.has("underline")) formData.set("underline", form.querySelector('input[name="underline"]').checked ? "true" : "false");
        try {
          const res = await fetch(`${API_BASE}/preview`, {
            method: "POST",
            body: formData
          });
          if (!res.ok) {
            const errorText = await res.text();
            encounteredError = `Document "${formData.get("filename") || `#${i+1}`}" failed: ${errorText}`;
            break;
          }
          const blob = await res.blob();
          const name = formData.get("filename") || `Document ${i+1}`;
          // To allow download, create an object URL
          const url = URL.createObjectURL(blob);
          previewDocsToShow.push({ name, blob, url, _tempUrl: url, formData });
        } catch (err) {
          encounteredError = `Document "${formData.get("filename") || `#${i+1}`}" failed: ${err}`;
          break;
        }
      }

      hideSpinner();

      if (encounteredError) {
        alert(encounteredError);
        // Clean up object URLs in case of partial success
        previewDocsToShow.forEach(doc => { if (doc._tempUrl) URL.revokeObjectURL(doc._tempUrl); });
        return;
      }

      // Launch previewer modal
      openPdfPreviewer(previewDocsToShow, 0);
    });

    // Add tab button now just creates a blank tab:
    document.getElementById("add-tab").addEventListener("click", function(e) {
      if (getTabCount() < MAX_DOCS) {
        createTab();
      }
      updateAddTabButton();
      updateTabBarCount();
    });
  </script>
</body>
</html>
