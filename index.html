
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Utmatic PDF Processor</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #1a1a1a;
      color: #efefe4;
      display: flex;
      justify-content: center;
      padding: 2rem;
    }
    .container {
      background: #2a2a2a;
      padding: 2rem;
      border-radius: 12px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    input, select {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.25rem;
      border-radius: 8px;
      border: none;
      margin-bottom: 0.75rem;
    }
    button {
      width: 100%;
      padding: 0.75rem;
      background: #3579c4;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
    }
    #previewModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.85);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #pdfViewer {
      background: white;
      padding: 1rem;
      border-radius: 1rem;
      max-width: 60vw;
      max-height: 90vh;
      overflow: auto;
      position: relative;
    }
    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ff4d4d;
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 1.2rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Power Up Your PDFs</h1>
    <form id="pdfForm" enctype="multipart/form-data">
      <label>Upload PDF:</label>
      <input type="file" name="file" id="pdfFile" required />

      <label>Select Service:</label>
      <select id="serviceType" name="serviceType" required>
        <option value="utm_only">Add UTM to Existing Links</option>
        <option value="hyperlink_and_utm">Add Hyperlinks + UTM</option>
      </select>

      <label>UTM Source:</label>
      <input type="text" name="utm_source" required />
      <label>UTM Medium:</label>
      <input type="text" name="utm_medium" required />
      <label>UTM Campaign:</label>
      <input type="text" name="utm_campaign" required />

      <div id="conditionalFields">
        <label>Item Format(s):</label>
        <input type="text" name="item_formats" placeholder="e.g. NNNN-NNNN, LL-NNN" />
        <label>Base URL:</label>
        <input type="text" name="base_url" placeholder="https://example.com/product?catalogId=" />
      </div>

      <button type="submit">Process PDF</button>
    </form>
  </div>

  <div id="previewModal">
    <div id="pdfViewer">
      <button class="close-btn" onclick="document.getElementById('previewModal').style.display='none'">Ã—</button>
      <canvas id="pdfCanvas"></canvas>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>
    const form = document.getElementById("pdfForm");
    const serviceTypeSelect = document.getElementById("serviceType");
    const conditionalFields = document.getElementById("conditionalFields");

    serviceTypeSelect.addEventListener("change", () => {
      const show = serviceTypeSelect.value === "hyperlink_and_utm";
      conditionalFields.style.display = show ? "block" : "none";
    });
    conditionalFields.style.display = "none";

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);

      try {
        const res = await fetch("https://utmatic-backend.onrender.com/process_pdf/", {
          method: "POST",
          body: formData
        });

        if (!res.ok) throw new Error("Failed to process PDF");

        const blob = await res.blob();
        const previewPath = res.headers.get("X-Preview-Path");

        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "processed.pdf";
        a.click();

        if (previewPath) {
          showPreviewPDF("https://utmatic-backend.onrender.com" + previewPath);
        }
      } catch (err) {
        alert("Error: " + err.message);
      }
    });

    function showPreviewPDF(pdfUrl) {
      const modal = document.getElementById("previewModal");
      const canvas = document.getElementById("pdfCanvas");
      const ctx = canvas.getContext("2d");

      modal.style.display = "flex";

      const loadingTask = pdfjsLib.getDocument(pdfUrl);
      loadingTask.promise.then(pdf => {
        return pdf.getPage(1).then(page => {
          const viewport = page.getViewport({ scale: 1.5 });
          canvas.height = viewport.height;
          canvas.width = viewport.width;

          const renderContext = {
            canvasContext: ctx,
            viewport: viewport
          };
          page.render(renderContext);
        });
      });
    }
  </script>
</body>
</html>
